<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Crypto Dashboard v7 â€” Precio editable</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>

<style>
:root{
  --bg:#111; --panel:#1b1b1b; --gold:#ffcc00;
  --muted:#aaa; --muted2:#bbb; --ok:#1db954; --warn:#eab308; --bad:#ef4444;
}
*{box-sizing:border-box}
body{margin:0;font-family:'Poppins',sans-serif;background:var(--bg);color:#fff;}
.nav{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:#0f0f0f;border-bottom:1px solid #222;}
.brand{color:var(--gold);font-weight:600;}
.meta{display:flex;align-items:center;gap:10px;color:var(--muted)}
.btn{background:transparent;border:1px solid var(--gold);color:var(--gold);padding:6px 10px;border-radius:8px;cursor:pointer}
.btn:hover{background:rgba(255,204,0,.08)}
.wrap{display:grid;grid-template-columns:1.2fr .8fr;gap:20px;padding:20px;max-width:1200px;margin:0 auto;align-items:start;}
@media(max-width:980px){.wrap{grid-template-columns:1fr}}
.card{background:var(--panel);border-radius:12px;box-shadow:0 0 14px rgba(255,204,0,.08);overflow:hidden;}
.card h2{margin:0;padding:16px;border-bottom:1px solid #222;color:var(--gold);}
.card .body{padding:16px}
table{width:100%;border-collapse:collapse;}
th,td{padding:10px 14px;text-align:left}
th{background:var(--gold);color:#111;text-transform:uppercase;font-size:.9rem}
tr:nth-child(even){background:#222}
tr:hover{background:#2a2a2a}
.coin{color:var(--gold);font-weight:600;cursor:pointer}
.price{font-weight:600}
.reco{color:var(--gold);font-weight:600}
.trend{font-weight:700}
.trend.ok{color:var(--ok)} .trend.mid{color:var(--warn)} .trend.bad{color:var(--bad)}
.last{color:var(--muted);font-size:.9rem;margin-top:8px}
#chartPanel{margin-top:20px;border-top:1px solid #222;background:#1b1b1b;border-radius:0 0 12px 12px;padding-bottom:20px;}
#grafCanvas{width:100%;max-height:380px}
#portfolioCard{max-height:calc(380px + 270px);overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--gold) #222;}
#portfolioCard::-webkit-scrollbar{width:8px}
#portfolioCard::-webkit-scrollbar-thumb{background-color:var(--gold);border-radius:10px}
.input,.select{width:100%;background:#222;color:#fff;border:1px solid #333;border-radius:8px;padding:9px 10px}
.table-mini{width:100%;border-collapse:collapse;margin-top:10px}
.table-mini th{background:#232323;color:#ddd}
.table-mini td,.table-mini th{padding:8px 10px;font-size:.9rem}
input[type="number"].edit-price {
  width: 100%;
  background: #222;
  border: 1px solid #333;
  border-radius: 6px;
  color: #fff;
  padding: 4px 6px;
  text-align: right;
}
.small{font-size:.86rem}
.muted{color:var(--muted2)}
#pieCanvas{max-height:240px}
.group-header{background:#222;color:var(--gold);font-weight:600;text-align:center;padding:6px 0;border-top:1px solid #333}
</style>
</head>
<body>

<div class="nav">
  <div class="brand">Crypto Dashboard</div>
  <div class="meta">
    <span id="lastUpdate" class="small">â€”</span>
    <button id="btnRefresh" class="btn">ðŸ”„ Actualizar</button>
  </div>
</div>

<div class="wrap">
  <div class="card" id="pricesCard">
    <h2>Precios y Tendencias</h2>
    <div class="body">
      <table id="tabla">
        <thead>
          <tr><th>Criptomoneda</th><th>Precio USD</th><th>% Recomendado</th><th>Tendencia</th></tr>
        </thead>
        <tbody>
          <tr data-coin="bitcoin"><td class="coin">Bitcoin (BTC)</td><td id="btc">â€”</td><td id="btc-reco">â€”</td><td id="btc-trend">â€”</td></tr>
          <tr data-coin="ethereum"><td class="coin">Ethereum (ETH)</td><td id="eth">â€”</td><td id="eth-reco">â€”</td><td id="eth-trend">â€”</td></tr>
          <tr data-coin="solana"><td class="coin">Solana (SOL)</td><td id="sol">â€”</td><td id="sol-reco">â€”</td><td id="sol-trend">â€”</td></tr>
        </tbody>
      </table>
      <div class="last" id="hora">Ãšltima actualizaciÃ³n: â€”</div>
    </div>
    <div id="chartPanel">
      <h2 id="titulo">HistÃ³rico</h2>
      <div class="body">
        <select id="rango">
          <option value="7">7 dÃ­as</option>
          <option value="30">30 dÃ­as</option>
          <option value="90" selected>90 dÃ­as</option>
          <option value="365">1 aÃ±o</option>
        </select>
        <canvas id="grafCanvas"></canvas>
      </div>
    </div>
  </div>

  <div class="card" id="portfolioCard">
    <h2>
      Portafolio
      <span style="float:right; font-size:0.8rem; color:var(--muted);">
        Mostrar por:
        <label><input type="radio" name="pieMode" value="inv" checked> Invertido</label>
        <label style="margin-left:8px;"><input type="radio" name="pieMode" value="cur"> Valor actual</label>
      </span>
    </h2>
    <div class="body">
      <canvas id="pieCanvas"></canvas>
      <table class="table-mini">
        <thead><tr><th>Moneda</th><th>Invertido</th><th>Actual</th><th>P/L</th></tr></thead>
        <tbody id="coinSummary"></tbody>
      </table>
      <hr>
      <table class="table-mini" id="txTable">
        <thead><tr><th>Fecha</th><th>Moneda</th><th>Monto USD</th><th>Precio Compra</th><th></th></tr></thead>
        <tbody id="txTbody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const $=s=>document.querySelector(s);
const fmt=n=>isFinite(n)?n.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}):'â€”';
let STATE={prices:{},txs:[],pie:null};
const COINS=[{id:'bitcoin',sym:'BTC',el:'#btc'},{id:'ethereum',sym:'ETH',el:'#eth'},{id:'solana',sym:'SOL',el:'#sol'}];

async function fetchPrices(){
  const ids=COINS.map(c=>c.id).join(',');
  const r=await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=usd`);
  const d=await r.json();
  STATE.prices={BTC:d.bitcoin.usd,ETH:d.ethereum.usd,SOL:d.solana.usd};
  COINS.forEach(c=>$(c.el).textContent=`$${fmt(STATE.prices[c.sym])}`);
  $('#hora').textContent='Actualizado: '+new Date().toLocaleTimeString();
}
function saveLS(){localStorage.setItem('crypto_v7_txs',JSON.stringify(STATE.txs));}
function loadLS(){STATE.txs=JSON.parse(localStorage.getItem('crypto_v7_txs')||'[]');renderTx();}
function renderTx(){
  const tb=$('#txTbody');tb.innerHTML='';
  STATE.txs.forEach((t,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${t.date}</td>
      <td>${t.coin}</td>
      <td>$${fmt(t.usd)}</td>
      <td><input type="number" step="0.01" class="edit-price" value="${t.buyPrice||0}" data-i="${i}"></td>
      <td><button class="btn small" data-i="${i}">ðŸ—‘</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('.edit-price').forEach(inp=>{
    inp.addEventListener('change',e=>{
      const i=e.target.dataset.i;
      STATE.txs[i].buyPrice=parseFloat(e.target.value);
      saveLS();updateTotals();
    });
  });
  tb.querySelectorAll('button').forEach(b=>{
    b.onclick=()=>{STATE.txs.splice(b.dataset.i,1);saveLS();renderTx();updateTotals();}
  });
  updateTotals();
}
function updateTotals(){
  let inv=0,cur=0;
  const coins={BTC:{inv:0,cur:0},ETH:{inv:0,cur:0},SOL:{inv:0,cur:0}};
  STATE.txs.forEach(t=>{
    const now=STATE.prices[t.coin];
    inv+=t.usd;
    const val=(now*t.usd)/(t.buyPrice||now);
    cur+=val;
    coins[t.coin].inv+=t.usd;
    coins[t.coin].cur+=val;
  });
  const tbody=$('#coinSummary');tbody.innerHTML='';
  Object.keys(coins).forEach(c=>{
    if(!coins[c].inv)return;
    const p=coins[c].cur-coins[c].inv;
    tbody.innerHTML+=`<tr><td>${c}</td><td>$${fmt(coins[c].inv)}</td><td>$${fmt(coins[c].cur)}</td><td style="color:${p>=0?'var(--ok)':'var(--bad)'};">${p>=0?'+':''}$${fmt(p)}</td></tr>`;
  });
  const mode=document.querySelector('input[name="pieMode"]:checked').value;
  const labels=['BTC','ETH','SOL'];
  const data=labels.map(c=>mode==='cur'?coins[c].cur:coins[c].inv);
  if(STATE.pie)STATE.pie.destroy();
  STATE.pie=new Chart($('#pieCanvas'),{type:'pie',data:{labels,datasets:[{data,backgroundColor:['#f7931a','#627eea','#14f195']}]},options:{plugins:{legend:{labels:{color:'#fff'}}}}});
}

(async()=>{
  loadLS();await fetchPrices();updateTotals();
  setInterval(fetchPrices,300000);
})();
</script>
</body>
</html>
