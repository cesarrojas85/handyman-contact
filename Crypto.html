<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Crypto Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>

<style>
:root{
  --bg:#111; --panel:#1b1b1b; --gold:#ffcc00;
  --muted:#aaa; --muted2:#bbb; --ok:#1db954; --warn:#eab308; --bad:#ef4444;
}
*{box-sizing:border-box}
body{margin:0;font-family:'Poppins',sans-serif;background:var(--bg);color:#fff;}
.nav{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:#0f0f0f;border-bottom:1px solid #222;}
.brand{color:var(--gold);font-weight:600;letter-spacing:.5px}
.meta{display:flex;align-items:center;gap:10px;color:var(--muted)}
.btn{background:transparent;border:1px solid var(--gold);color:var(--gold);padding:6px 10px;border-radius:8px;cursor:pointer}
.btn:hover{background:rgba(255,204,0,.08)}
.wrap{display:grid;grid-template-columns:1.2fr .8fr;gap:20px;padding:20px;max-width:1200px;margin:0 auto;align-items:start;}
@media(max-width:980px){.wrap{grid-template-columns:1fr}}
.card{background:var(--panel);border-radius:12px;box-shadow:0 0 14px rgba(255,204,0,.08);overflow:hidden;}
.card h2{margin:0;padding:16px;border-bottom:1px solid #222;color:var(--gold);font-size:1.05rem;letter-spacing:.3px}
.card .body{padding:16px}
table{width:100%;border-collapse:collapse;}
th,td{padding:10px 14px;text-align:left}
th{background:var(--gold);color:#111;text-transform:uppercase;font-size:.9rem}
tr:nth-child(even){background:#222}
tr:hover{background:#2a2a2a}
.coin{color:var(--gold);font-weight:600;cursor:pointer}
.price{font-weight:600}
.reco{color:var(--gold);font-weight:600}
.trend{font-weight:700}
.trend.ok{color:var(--ok)} .trend.mid{color:var(--warn)} .trend.bad{color:var(--bad)}
.last{color:var(--muted);font-size:.9rem;margin-top:8px}
#chartPanel{margin-top:20px;border-top:1px solid #222;background:#1b1b1b;border-radius:0 0 12px 12px;padding-bottom:20px;}
#grafCanvas{width:100%;max-height:380px}
#portfolioCard{max-height:calc(380px + 270px);overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--gold) #222;}
#portfolioCard::-webkit-scrollbar{width:8px}
#portfolioCard::-webkit-scrollbar-thumb{background-color:var(--gold);border-radius:10px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:720px){.grid2{grid-template-columns:1fr}}
.input,.select{width:100%;background:#222;color:#fff;border:1px solid #333;border-radius:8px;padding:9px 10px}
.tally{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
.pill{background:#151515;padding:10px;border-radius:10px;border:1px solid #232323}
.pill .lab{color:var(--muted2);font-size:.85rem}
.pill .val{font-weight:700;margin-top:4px}
.table-mini{width:100%;border-collapse:collapse;margin-top:10px}
.table-mini th{background:#232323;color:#ddd}
.table-mini td,.table-mini th{padding:8px 10px;font-size:.92rem}
.row{display:flex;align-items:center;justify-content:space-between;gap:10px}
.small{font-size:.86rem}
.muted{color:var(--muted2)}
.group-header{background:#222;color:var(--gold);font-weight:600;text-align:center;padding:6px 0;border-top:1px solid #333}
.sub-summary{margin-top:16px;border-top:1px solid #333;padding-top:10px}
.sub-summary table td, .sub-summary table th{font-size:.9rem;}
#pieCanvas{max-height:240px}
input[type="number"].edit-price {
  width: 100%;
  background: #222;
  border: 1px solid #333;
  border-radius: 6px;
  color: #fff;
  padding: 4px 6px;
  text-align: right;
}
</style>
</head>
<body>

<div class="nav">
  <div class="brand">Crypto Dashboard</div>
  <div class="meta">
    <span id="lastUpdate" class="small">‚Äî</span>
    <button id="btnRefresh" class="btn">üîÑ Actualizar</button>
  </div>
</div>

<div class="wrap">
  <!-- IZQUIERDA -->
  <div class="card" id="pricesCard">
    <h2>Precios, Recomendaci√≥n (90d) y Tendencia</h2>
    <div class="body">
      <table id="tabla">
        <thead>
          <tr><th>Criptomoneda</th><th>Precio (USD)</th><th>% Recomendado</th><th>Tendencia</th></tr>
        </thead>
        <tbody>
          <tr data-coin="bitcoin"><td class="coin">Bitcoin (BTC)</td><td id="btc" class="price">‚Äî</td><td id="btc-reco" class="reco">‚Äî</td><td id="btc-trend" class="trend">‚Äî</td></tr>
          <tr data-coin="ethereum"><td class="coin">Ethereum (ETH)</td><td id="eth" class="price">‚Äî</td><td id="eth-reco" class="reco">‚Äî</td><td id="eth-trend" class="trend">‚Äî</td></tr>
          <tr data-coin="solana"><td class="coin">Solana (SOL)</td><td id="sol" class="price">‚Äî</td><td id="sol-reco" class="reco">‚Äî</td><td id="sol-trend" class="trend">‚Äî</td></tr>
        </tbody>
      </table>
      <div class="last" id="hora">√öltima actualizaci√≥n: ‚Äî</div>
    </div>
    <div id="chartPanel">
      <h2 id="titulo">Hist√≥rico</h2>
      <div class="body">
        <div class="row">
          <div class="muted small">Rango</div>
          <select id="rango">
            <option value="7">7 d√≠as</option>
            <option value="30">30 d√≠as</option>
            <option value="90" selected>90 d√≠as</option>
            <option value="365">1 a√±o</option>
          </select>
        </div>
        <canvas id="grafCanvas"></canvas>
      </div>
    </div>
  </div>

  <!-- DERECHA -->
  <div class="card" id="portfolioCard">
    <h2>
      Portafolio (compras manuales + saldo PayPal)
      <span style="float:right; font-size:0.8rem; color:var(--muted);">
        Mostrar por:
        <label><input type="radio" name="pieMode" value="inv" checked> Invertido</label>
        <label style="margin-left:8px;"><input type="radio" name="pieMode" value="cur"> Valor actual</label>
      </span>
    </h2>
    <div class="body">

      <div class="sub-summary">
        <h3 class="small muted" style="margin-bottom:8px;">Resumen por moneda</h3>
        <table class="table-mini">
          <thead><tr><th>Moneda</th><th>Invertido</th><th>Actual</th><th>P/L</th></tr></thead>
          <tbody id="coinSummary"></tbody>
        </table>
      </div>

      <div style="margin-bottom:20px;">
        <h3 class="small muted" id="pieTitle" style="margin-bottom:8px;">Distribuci√≥n del Portafolio (por inversi√≥n)</h3>
        <canvas id="pieCanvas"></canvas>
      </div>

      <div class="grid2">
        <div>
          <div class="muted small">Saldo PayPal</div>
          <input id="paypalBalance" class="input" type="number" step="0.01" placeholder="Ej. 1200.00" />
        </div>
        <div class="row" style="justify-content:flex-end;gap:10px">
          <button id="btnSavePayPal" class="btn">üíæ Guardar</button>
          <button id="btnExport" class="btn">‚¨áÔ∏è Exportar</button>
          <input type="file" id="fileImport" accept=".json" style="display:none">
          <button id="btnImport" class="btn">‚¨ÜÔ∏è Importar</button>
          <button id="btnClearAll" class="btn">üóëÔ∏è Limpiar</button>
        </div>
      </div>

      <div class="tally">
        <div class="pill"><div class="lab">Invertido</div><div class="val" id="sumInvested">$0.00</div></div>
        <div class="pill"><div class="lab">Actual</div><div class="val" id="sumCurrent">$0.00</div></div>
        <div class="pill"><div class="lab">P/L</div><div class="val" id="sumPnL">$0.00</div></div>
      </div>

      <div class="grid2" style="margin-top:14px">
        <div>
          <label class="small muted">Moneda</label>
          <select id="txCoin" class="select">
            <option value="BTC">BTC</option>
            <option value="ETH">ETH</option>
            <option value="SOL">SOL</option>
          </select>
        </div>
        <div>
          <label class="small muted">Fecha</label>
          <input id="txDate" class="input" type="date" />
        </div>
        <div>
          <label class="small muted">Monto USD</label>
          <input id="txUsd" class="input" type="number" step="0.01" placeholder="Ej. 250.00" />
        </div>
        <div class="row" style="align-items:end;justify-content:flex-end">
          <button id="btnAddTx" class="btn">‚ûï Agregar</button>
        </div>
      </div>

      <table class="table-mini" id="txTable">
        <thead><tr><th>Fecha</th><th>Moneda</th><th>Monto USD</th><th>Precio Compra</th><th></th></tr></thead>
        <tbody id="txTbody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const $=s=>document.querySelector(s);
const fmt=n=>isFinite(n)?n.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}):'‚Äî';
const COINS=[{id:'bitcoin',sym:'BTC',priceEl:'#btc',recoEl:'#btc-reco',trendEl:'#btc-trend'},{id:'ethereum',sym:'ETH',priceEl:'#eth',recoEl:'#eth-reco',trendEl:'#eth-trend'},{id:'solana',sym:'SOL',priceEl:'#sol',recoEl:'#sol-reco',trendEl:'#sol-trend'}];
let STATE={prices:{},chart:null,pie:null,txs:[],paypal:0,currentCoinId:null,currentCoinName:null};

// ‚úÖ EXPORTAR RESPALDO
function exportBackup(){
  if(!STATE.txs.length){return alert('No hay transacciones que exportar.');}
  const dataStr="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(STATE.txs,null,2));
  const link=document.createElement('a');
  link.setAttribute('href',dataStr);
  link.setAttribute('download','crypto_portfolio_backup.json');
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// ‚úÖ IMPORTAR RESPALDO
function importBackup(file){
  const reader=new FileReader();
  reader.onload=function(e){
    try{
      const imported=JSON.parse(e.target.result);
      if(!Array.isArray(imported)) throw new Error("Formato inv√°lido");
      STATE.txs=imported;
      saveLS();
      renderTx();
      alert('Respaldo importado correctamente.');
    }catch(err){
      alert('Error al importar el respaldo: '+err.message);
    }
  };
  reader.readAsText(file);
}

// --- RESTO DEL C√ìDIGO ORIGINAL SIN CAMBIOS ---
async function fetchPrices(){const ids=COINS.map(c=>c.id).join(',');const r=await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=usd`);const d=await r.json();STATE.prices={BTC:d.bitcoin.usd,ETH:d.ethereum.usd,SOL:d.solana.usd};COINS.forEach(c=>$(c.priceEl).textContent=`$${fmt(STATE.prices[c.sym])}`);const ts='√öltima actualizaci√≥n: '+new Date().toLocaleTimeString();$('#hora').textContent=ts;$('#lastUpdate').textContent=ts;}
function loadLS(){try{STATE.txs=JSON.parse(localStorage.getItem('crypto_v5_txs')||'[]');STATE.paypal=parseFloat(localStorage.getItem('crypto_v5_paypal')||'0')||0;}catch{STATE.txs=[];STATE.paypal=0;}$('#paypalBalance').value=STATE.paypal||'';renderTx();}
function saveLS(){localStorage.setItem('crypto_v5_txs',JSON.stringify(STATE.txs));}

// üì¶ EVENTOS NUEVOS
$('#btnExport').onclick=exportBackup;
$('#btnImport').onclick=()=>$('#fileImport').click();
$('#fileImport').onchange=e=>{if(e.target.files.length)importBackup(e.target.files[0]);};

// ... resto del JS sigue igual ...
</script>
</body>
</html>
